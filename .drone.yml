kind: pipeline
type: docker
name: main

workspace:
  path: /app

environment:
  # JWT
  JWT_ALGORITHM: "HS256"
  JWT_EXPIRE_TIME: 120
  # Application
  APPLICATION_NAME: "application_testing"
  APPLICATION_ENVIRONMENT: "TEST"
  APPLICATION_LOG_LEVEL: "DEBUG"
  APPLICATION_LOG_PATH: "/var/log/application"

steps:
  - name: application testing
    image: python:3.9-slim
    environment:
      PYTHONDONTWRITEBYTECODE: 1
      PYTHONUNBUFFERED: 1
      ENVIRONMENT: TEST
      JWT_SECRET_KEY:
        from_secret: JWT_SECRET_KEY

    commands:
      - pip install --upgrade pip poetry cookiecutter
      - chmod +x test.sh
      - bash test.sh


  - name: telegram bot notification
    image: appleboy/drone-telegram
    when:
      status:
        - failure
        - success
    settings:
      token:
        from_secret: Telegram_gggoingdown_bot_token
      to:
        from_secret: Telegram_chat_id
      message: >
        {{#success build.status}}
          Repository: {{repo.name}}
          Version: {{build.number}}
          Commit message:  {{commit.message}}
          Message: Test succeeded. Good job.
        {{else}}
          Repository: {{repo.name}}
          Version: {{build.number}}
          Commit message:  {{commit.message}}
          Message: Test failed. Fix me please.
        {{/success}}

trigger:
  branch:
    - master
    - test/*
    - feature/*
    - fastapi/*
